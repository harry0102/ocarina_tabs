<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8"/>
		<meta name="viewport" content="width=800, initial-scale=1"/>
		<title>12 Hole Ocarina Tabs</title>
		<style type="text/css">
			@font-face {
				font-family: "12 Hole Ocarina";
				src: url("Ocarina-12-Hole.ttf");
			}

			html, body {
				margin: 0;
				padding: 0;
				font-family: sans-serif;
				height: 100%;
			}

			.tabs {
				font-family: "12 Hole Ocarina", monospace;
				white-space: pre;
				padding: 100px 20px 20px 20px;
				outline: none;
				box-sizing: border-box;
				min-height: 100%;
				line-height: 1.5;
			}

			input[type=number] {
				text-align: right;
				width: 4em;
			}

			.controls {
				position: fixed;
				left: 0;
				right: 0;
				top: 0;
				background: white;
				border-bottom: 1px solid lightgray;
				padding: 10px;
			}

			.controls-cell {
				display: inline-block;
			}

			.controls-line {
				display: block;
				margin: 5px;
			}

			button, select {
				cursor: pointer;
			}

			button:hover, select:hover, input:hover {
				background: #eeeeee;
			}

			button, select, input {
				padding: 0.1em 0.5em;
				border: 1px solid lightgray;
				border-radius: 5px;
				background: white;
			}

			@media print {
				.tabs {
					padding: 20px;
				}

				.controls {
					display: none;
				}
			}
		</style>
		<script type="text/javascript">
		// <![CDATA[
			function parseParams (search) {
				search = search.replace(/^\?/,'');
				var params = {};
				if (search) {
					search = search.split("&");
					for (var i = 0; i < search.length; ++ i) {
						var pair = search[i].split("=");
						params[decodeURIComponent(pair[0])] = decodeURIComponent(pair.slice(1).join("="));
					}
				}
				return params;
			}

			function updateStyle() {
				var size = Number(document.getElementById("font_size").value);
				var unit = document.getElementById("font_size_unit").value;
				var editor = document.getElementById("editor");
				editor.style.fontSize = size+unit;
			}

			var lastCursor = null;
			function init() {
				var editor = document.getElementById("editor");
				updateStyle();

				var tabs = parseParams(location.search).tabs;
				if (tabs) {
					editor.innerHTML = '';
					editor.appendChild(document.createTextNode(tabs));
				}

				editor.addEventListener("paste", function (event) {
					event.preventDefault();

					var text = event.clipboardData.getData("text/plain");
					document.execCommand('insertText', false, text);
					//insertTextAtCursor(text);
				}, false);
				
				editor.addEventListener("drop", function (event) {
					event.preventDefault();

					var text = event.dataTransfer.getData("text/plain");
					document.execCommand('insertText', false, text);
					//insertTextAtCursor(text);
				}, false);

				
				editor.addEventListener("blur", function (event) {
					lastCursor = getSelectionRange();
				}, true);

				var full_notes = document.getElementById("full_notes");
				var other_notes = document.getElementById("other_notes");

				var full_keys = ["A","C","D","F","H","I","K","M","O","P","R","T","U"];
				var full_labels = ["A","B","C","D","E","F","G","A²","B²","C²","D²","E²","F²"];

				var other_keys = ["B","E","G","J","L","N","Q","S"," ","-","\n"];
				var other_labels = ["A#","C#","D#","F#","G#","A#²","C#²","D#²","\u00a0","–","\u21B5"];

				addButtons(full_notes, full_keys, full_labels);
				addButtons(other_notes, other_keys, other_labels);

				editor.focus();
			}

			function addButtons (parent, keys, labels) {
				for (var i = 0; i < keys.length; ++ i) {
					var key = keys[i];
					var label = labels[i];
					var button = document.createElement("button");
					button.type = "button";
					button.title = key;
					button.appendChild(document.createTextNode(label));
					button.addEventListener("click", makeInserter(key), false);
					parent.appendChild(button);
					parent.appendChild(document.createTextNode(' '));
				}
			}

			function makeInserter (key) {
				var editor = document.getElementById("editor");

				return function (event) {
					if (lastCursor && document.activeElement !== editor) {
						setSelectionRange(lastCursor);
					}

					if (document.activeElement !== editor) {
						editor.focus();
						cursorManager.setEndOfContenteditable(editor);
					}

					document.execCommand('insertText', false, key);
				};
			}

			function insertTextAtCursor (text) {
				if (window.getSelection) {
					var sel = window.getSelection();
					if (sel.getRangeAt && sel.rangeCount) {
						var range = sel.getRangeAt(0);
						range.deleteContents();
						range.insertNode(document.createTextNode(text));
					}
				}
				else if (document.selection && document.selection.createRange) {
					document.selection.createRange().text = text;
				}
			}

			function insertTextAt (text, range) {
				if (window.getSelection) {
					range.deleteContents();
					range.insertNode(document.createTextNode(text));
				}
				else if (document.selection && document.selection.createRange) {
					range.text = text;
				}
			}

			function getSelectionRange () {
				if (window.getSelection) {
					var sel = window.getSelection();
					if (sel.getRangeAt && sel.rangeCount) {
						return sel.getRangeAt(0);
					}
				}
				else if (document.selection && document.selection.createRange) {
					return document.selection.createRange();
				}
				return null;
			}

			function setSelectionRange (range) {
				if (range) {
					if (window.getSelection) {
						var sel = window.getSelection();
						sel.removeAllRanges();
						sel.addRange(range);
					}
					else if (document.selection && range.select) {
						range.select();
					}
				}
			}

			function shareLink () {
				var editor = document.getElementById("editor");
				var url = location.href.replace(/[#\?].*/,'') + '?tabs=' + encodeURIComponent(getPlainText(editor));
				prompt("Share-Link:", url);
			}

			function getPlainText (element) {
				var buf = [];
				_getPlainText(element, buf);
				return buf.join("");
			}

			function _getPlainText (element, buf) {
				for (var el = element.firstChild; el; el = el.nextSibling) {
					if (el.nodeType === 1) {
						if (buf.length > 0 && buf[buf.length - 1] !== "\n") {
							buf.push("\n");
						}

						if (el.nodeName !== "STYLE" && el.nodeName !== "SCRIPT") {
							if (el.nodeName === "BR") {
								buf.push("\n");
							}
							else {
								_getPlainText(el, buf);
								if (buf.length > 0 && buf[buf.length - 1] !== "\n") {
									var display = getComputedStyle(el, null).getPropertyValue("display");
									console.log(display);
									if (display !== "inline" && display !== "inline-block") {
										buf.push("\n");
									}
								}
							}
						}
					}
					else if (el.nodeType === 3) {
						buf.push(el.textContent);
					}
				}
			}

// Source: https://developer.mozilla.org/en-US/docs/Web/API/HTMLCanvasElement/toBlob
if (!HTMLCanvasElement.prototype.toBlob) {
 Object.defineProperty(HTMLCanvasElement.prototype, 'toBlob', {
  value: function (callback, type, quality) {

    var binStr = atob(this.toDataURL(type, quality).split(',')[1]),
        len = binStr.length,
        arr = new Uint8Array(len);

    for (var i=0; i<len; i++ ) {
     arr[i] = binStr.charCodeAt(i);
    }

    callback(new Blob([arr], {type: type || 'image/png'}));
  }
 });
}

			function saveImage () {
				var size = Number(document.getElementById("font_size").value);
				var unit = document.getElementById("font_size_unit").value;
				var editor = document.getElementById("editor");
				var lines = getPlainText(editor).split("\n");
				var canvas = document.createElement("canvas");
				canvas.width  = Math.max(editor.offsetWidth, editor.scrollWidth||0);
				canvas.height = Math.max(editor.offsetHeight, editor.scrollHeight||0) - 80;
				
				var ctx = canvas.getContext("2d");
				ctx.fillStyle = '#FFFFFF';
				ctx.fillRect(0, 0, canvas.width, canvas.height);
				
				ctx.fillStyle = '#000000';
				ctx.font = size+unit+' "12 Hole Ocarina", monospace';
				ctx.textBaseline = "top";

				var measureEl = document.createElement("div");
				var style = getComputedStyle(editor, null);

				measureEl.style.font = style.getPropertyValue("font");
				measureEl.style.lineHeight = style.getPropertyValue("line-height");
				measureEl.style.whiteSpace = "nowrap";
				measureEl.style.visibility = "hidden";
				measureEl.style.position = "absolute";
				measureEl.style.right = "0";
				measureEl.style.bottom = "0";
				measureEl.appendChild(document.createTextNode("A- "));
				document.body.appendChild(measureEl);
				var line_height = measureEl.offsetHeight;
				document.body.removeChild(measureEl);

				var y = 20;
				for (var i = 0; i < lines.length; ++ i) {
					var line = lines[i];
					ctx.fillText(line, 20, y);
					y += line_height;
				}

				canvas.toBlob(function (blob) {
					var url = URL.createObjectURL(blob);
					var link = document.createElement("a");
					
					link.download = "12_hole_ocarina_tabs.png";
					link.href = url;
					link.style.visibility = 'hidden';
					link.style.position = 'absolute';
					link.style.right = '0';
					link.style.bottom = '0';
					document.body.appendChild(link);
					
					link.click();

					setTimeout(function () {
						document.body.removeChild(link);
						URL.revokeObjectURL(url);
					}, 50);
				}, 'image/png');
			}

// Source: http://stackoverflow.com/questions/1125292/how-to-move-cursor-to-end-of-contenteditable-entity
(function( cursorManager ) {

    //From: http://www.w3.org/TR/html-markup/syntax.html#syntax-elements
    var voidNodeTags = ['AREA', 'BASE', 'BR', 'COL', 'EMBED', 'HR', 'IMG', 'INPUT', 'KEYGEN', 'LINK', 'MENUITEM', 'META', 'PARAM', 'SOURCE', 'TRACK', 'WBR', 'BASEFONT', 'BGSOUND', 'FRAME', 'ISINDEX'];

    //From: http://stackoverflow.com/questions/237104/array-containsobj-in-javascript
    Array.prototype.contains = function(obj) {
        var i = this.length;
        while (i--) {
            if (this[i] === obj) {
                return true;
            }
        }
        return false;
    }

    //Basic idea from: http://stackoverflow.com/questions/19790442/test-if-an-element-can-contain-text
    function canContainText(node) {
        if(node.nodeType == 1) { //is an element node
            return !voidNodeTags.contains(node.nodeName);
        } else { //is not an element node
            return false;
        }
    };

    function getLastChildElement(el){
        var lc = el.lastChild;
        while(lc && lc.nodeType != 1) {
            if(lc.previousSibling)
                lc = lc.previousSibling;
            else
                break;
        }
        return lc;
    }

    //Based on Nico Burns's answer
    cursorManager.setEndOfContenteditable = function(contentEditableElement)
    {

        while(getLastChildElement(contentEditableElement) &&
              canContainText(getLastChildElement(contentEditableElement))) {
            contentEditableElement = getLastChildElement(contentEditableElement);
        }

        var range,selection;
        if(document.createRange)//Firefox, Chrome, Opera, Safari, IE 9+
        {    
            range = document.createRange();//Create a range (a range is a like the selection but invisible)
            range.selectNodeContents(contentEditableElement);//Select the entire contents of the element with the range
            range.collapse(false);//collapse the range to the end point. false means collapse to end rather than the start
            selection = window.getSelection();//get the selection object (allows you to change selection)
            selection.removeAllRanges();//remove any selections already made
            selection.addRange(range);//make the range you have just created the visible selection
        }
        else if(document.selection)//IE 8 and lower
        { 
            range = document.body.createTextRange();//Create a range (a range is a like the selection but invisible)
            range.moveToElementText(contentEditableElement);//Select the entire contents of the element with the range
            range.collapse(false);//collapse the range to the end point. false means collapse to end rather than the start
            range.select();//Select the range (make it the visible selection
        }
    }

}( window.cursorManager = window.cursorManager || {}));
		// ]]>
		</script>
	</head>
	<body onload="init();">
		<div class="controls">
			<span class="controls-cell">
				<span class="controls-line" id="other_notes"></span>
				<span class="controls-line" id="full_notes"></span>
			</span>

			<span class="controls-cell">
				<span class="controls-line">
					<label>Font-Size:
						<input type="number" id="font_size" onchange="updateStyle();" value="64"/>
					</label>
					<select id="font_size_unit" onchange="updateStyle();">
						<option value="px" selected>px</option>
						<option value="mm">mm</option>
						<option value="cm">cm</option>
						<option value="in">in</option>
						<option value="pt">pt</option>
						<option value="pc">pc</option>
					</select>
				</span>
	
				<span class="controls-line">
					<button type="button" onclick="saveImage();">Save Image</button>
					<button type="button" onclick="shareLink();">Share Link</button>
					<button type="button" onclick="window.print();">Print</button>
				</span>
			</span>

		</div>
		<div class="tabs" id="editor" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" contentEditable="true"></div>
	</body>
</html>
